# 시스템 시퀀스 다이어그램 (System Sequence Diagrams)

## 1. 회원가입 (Register)

```mermaid
sequenceDiagram
    actor Customer
    participant AuthController
    participant AuthenticationService
    participant CustomerRepository
    participant Database

    Customer->>AuthController: POST /api/auth/register
    AuthController->>AuthenticationService: registerCustomer(request)
    AuthenticationService->>CustomerRepository: findByEmail(email)
    CustomerRepository-->>AuthenticationService: Optional.empty()
    AuthenticationService->>AuthenticationService: encryptPassword()
    AuthenticationService->>CustomerRepository: save(customer)
    CustomerRepository->>Database: INSERT
    Database-->>CustomerRepository: id
    CustomerRepository-->>AuthenticationService: Customer
    AuthenticationService-->>AuthController: customerId
    AuthController-->>Customer: 200 OK
```

## 2. 로그인 (Login)

```mermaid
sequenceDiagram
    actor User
    participant AuthController
    participant AuthenticationService
    participant CustomerRepository
    participant StaffRepository

    User->>AuthController: POST /api/auth/login
    AuthController->>AuthenticationService: authenticate(email, password)
    alt Customer Login
        AuthenticationService->>CustomerRepository: findByEmail(email)
        CustomerRepository-->>AuthenticationService: Customer
    else Staff Login
        AuthenticationService->>StaffRepository: findByEmail(email)
        StaffRepository-->>AuthenticationService: Staff
    end
    AuthenticationService->>AuthenticationService: verifyPassword(raw, encoded)
    AuthenticationService-->>AuthController: User
    AuthController-->>User: 200 OK
```

## 3. 주문 확정 (Confirm Order)

```mermaid
sequenceDiagram
    actor Customer
    participant Frontend
    participant OrderController
    participant OrderService
    participant MenuItemRepository
    participant CustomerRepository
    participant InventoryService
    participant InventoryRepository
    participant Inventory
    participant OrderRepository
    participant Database

    Customer->>Frontend: Click "Confirm Order"
    Frontend->>Frontend: checkBusinessHours()
    Frontend->>OrderController: POST /api/orders
    OrderController->>OrderService: createOrder(request)
    
    OrderService->>CustomerRepository: findById(customerId)
    CustomerRepository-->>OrderService: Customer

    loop For Each Item
        OrderService->>MenuItemRepository: findById(menuId)
        MenuItemRepository-->>OrderService: MenuItem
        OrderService->>InventoryService: deductStock(menuItem, quantity)
        InventoryService->>InventoryRepository: findById(stockId)
        InventoryRepository-->>InventoryService: Inventory
        InventoryService->>Inventory: decreaseQuantity(amount)
        Inventory->>Inventory: updateStatus()
        InventoryService->>Database: save(inventory)
    end

    OrderService->>OrderService: calculateTotalPrice()
    OrderService->>OrderRepository: countByCustomer(customer)
    OrderRepository-->>OrderService: orderCount
    OrderService->>OrderService: calculateDiscount()

    OrderService->>Database: save(order)
    Database-->>OrderService: Order
    OrderService-->>OrderController: orderId
    OrderController-->>Frontend: 200 OK (orderId)
    Frontend-->>Customer: Show Success Message
```

## 4. 음성 주문 (Voice Order)

```mermaid
sequenceDiagram
    actor Customer
    participant Frontend
    participant AIServer
    participant ChatOrchestratorService
    participant OrderService

    Customer->>Frontend: Voice Input
    Frontend->>AIServer: Send Audio
    AIServer->>AIServer: STT & Intent Extraction
    AIServer->>ChatOrchestratorService: Order Request
    ChatOrchestratorService->>OrderService: createOrderFromChat(userId, menu, qty)
    OrderService->>OrderService: createOrderLogic
    OrderService-->>ChatOrchestratorService: orderId
    ChatOrchestratorService-->>AIServer: Success Response
    AIServer-->>Frontend: Confirmation Message
    Frontend-->>Customer: Display Order
```

## 5. 주문 내역 조회 (View Orders)

```mermaid
sequenceDiagram
    actor Staff
    participant StaffOrderController
    participant StaffOrderService
    participant OrderRepository

    Staff->>StaffOrderController: GET /api/staff-orders
    StaffOrderController->>StaffOrderService: getOrders(status)
    StaffOrderService->>OrderRepository: findByStatus(status)
    OrderRepository-->>StaffOrderService: List<Order>
    StaffOrderService-->>StaffOrderController: List<OrderResponseDto>
    StaffOrderController-->>Staff: 200 OK
```

## 6. 주문 상태 변경 - 조리 완료 (Update to Ready)

```mermaid
sequenceDiagram
    actor KitchenStaff
    participant Frontend
    participant StaffOrderController
    participant StaffOrderService
    participant AccessControlService
    participant Staff
    participant OrderRepository
    participant OrderProcessLogRepository
    participant Database

    KitchenStaff->>Frontend: Click "Mark as Ready"
    Frontend->>StaffOrderController: PATCH .../status
    StaffOrderController->>StaffOrderService: updateStatusAndAudit(READY)

    StaffOrderService->>StaffOrderService: getStaffInfo()
    StaffOrderService->>AccessControlService: verifyStaffAccess(staff, READY)
    AccessControlService->>Staff: canHandle(READY)
    Staff-->>AccessControlService: true
    AccessControlService-->>StaffOrderService: void

    StaffOrderService->>OrderRepository: findById(orderId)
    OrderRepository-->>StaffOrderService: Order

    StaffOrderService->>OrderProcessLogRepository: save(log)
    OrderProcessLogRepository->>Database: INSERT

    StaffOrderService->>Database: updateStatus(READY)

    StaffOrderService-->>StaffOrderController: void
    StaffOrderController-->>Frontend: 200 OK
    Frontend-->>KitchenStaff: Update UI
```

## 7. 주문 상태 변경 - 배달 완료 (Update to Delivered)

```mermaid
sequenceDiagram
    actor DeliveryStaff
    participant Frontend
    participant StaffOrderController
    participant StaffOrderService
    participant AccessControlService
    participant Staff
    participant OrderRepository
    participant Database

    DeliveryStaff->>Frontend: Click "Complete Delivery"
    Frontend->>StaffOrderController: PATCH .../status
    StaffOrderController->>StaffOrderService: updateStatusAndAudit(DELIVERED)

    StaffOrderService->>AccessControlService: verifyStaffAccess(staff, DELIVERED)
    AccessControlService->>Staff: canHandle(DELIVERED)
    Staff-->>AccessControlService: true

    StaffOrderService->>OrderRepository: findById(orderId)
    StaffOrderService->>Database: save(log)
    StaffOrderService->>Database: updateStatus(DELIVERED)

    StaffOrderService-->>StaffOrderController: void
    StaffOrderController-->>Frontend: 200 OK
```

## 8. 재고 관리 - 입고 (Manage Inventory)

```mermaid
sequenceDiagram
    actor Staff
    participant Frontend
    participant InventoryController
    participant InventoryService
    participant InventoryRepository
    participant Inventory
    participant Database

    Staff->>Frontend: Click "Order More"
    Frontend->>InventoryController: POST .../add
    InventoryController->>InventoryService: increaseQuantity(id, amount)
    InventoryService->>InventoryRepository: findById(id)
    InventoryRepository-->>InventoryService: Inventory
    InventoryService->>Inventory: increaseQuantity(amount)
    Inventory->>Inventory: quantity.add(amount)
    Inventory->>Inventory: updateStatus()
    InventoryService->>Database: Transaction Commit
    InventoryController-->>Frontend: 200 OK
```
