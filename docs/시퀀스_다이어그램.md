# 시스템 시퀀스 다이어그램 (System Sequence Diagrams)

## 1. 회원가입 (Register)

```mermaid
sequenceDiagram
    actor Customer as 고객
    participant AuthController as 인증 컨트롤러
    participant AuthenticationService as 인증 서비스
    participant CustomerRepository as 고객 저장소
    participant Database as 데이터베이스

    Customer->>AuthController: 회원가입 요청 (POST /api/auth/register)
    AuthController->>AuthenticationService: registerCustomer(request)
    AuthenticationService->>CustomerRepository: 이메일 중복 확인 (findByEmail)
    CustomerRepository-->>AuthenticationService: 없음 (Empty)
    AuthenticationService->>AuthenticationService: 비밀번호 암호화
    AuthenticationService->>CustomerRepository: 고객 정보 저장 (save)
    CustomerRepository->>Database: INSERT
    Database-->>CustomerRepository: ID 반환
    CustomerRepository-->>AuthenticationService: Customer Entity
    AuthenticationService-->>AuthController: customerId
    AuthController-->>Customer: 200 OK
```

## 2. 로그인 (Login)

```mermaid
sequenceDiagram
    actor User as 사용자
    participant AuthController as 인증 컨트롤러
    participant AuthenticationService as 인증 서비스
    participant CustomerRepository as 고객 저장소
    participant StaffRepository as 직원 저장소

    User->>AuthController: 로그인 요청 (POST /api/auth/login)
    AuthController->>AuthenticationService: authenticate(email, pw)
    alt 고객 로그인 (Customer)
        AuthenticationService->>CustomerRepository: 이메일 조회 (findByEmail)
        CustomerRepository-->>AuthenticationService: Customer
    else 직원 로그인 (Staff)
        AuthenticationService->>StaffRepository: 이메일 조회 (findByEmail)
        StaffRepository-->>AuthenticationService: Staff
    end
    AuthenticationService->>AuthenticationService: 비밀번호 검증 (verifyPassword)
    AuthenticationService-->>AuthController: User Entity
    AuthController-->>User: 200 OK (토큰/정보 반환)
```

## 3. 주문 확정 (Confirm Order)

```mermaid
sequenceDiagram
    actor Customer as 고객
    participant Frontend as 프론트엔드 (주문 화면)
    participant OrderController as 주문 컨트롤러
    participant OrderService as 주문 서비스
    participant MenuItemRepository as 메뉴 저장소
    participant CustomerRepository as 고객 저장소
    participant InventoryService as 재고 서비스
    participant InventoryRepository as 재고 저장소
    participant InventoryEntity as 재고 엔티티
    participant OrderRepository as 주문 저장소
    participant Database as 데이터베이스

    Customer->>Frontend: "주문 확정" 버튼 클릭
    Frontend->>Frontend: 영업 시간 확인 (checkBusinessHours)
    Frontend->>OrderController: 주문 생성 요청 (POST /api/orders)
    OrderController->>OrderService: createOrder(request)
    
    OrderService->>CustomerRepository: 고객 조회 (findById)
    CustomerRepository-->>OrderService: User Entity

    loop 각 주문 항목에 대해 (For Each Item)
        OrderService->>MenuItemRepository: 메뉴 정보 조회 (findById)
        MenuItemRepository-->>OrderService: MenuItem Entity
        OrderService->>InventoryService: 재고 차감 요청 (deductStock)
        InventoryService->>InventoryRepository: 재고 조회 (findById)
        InventoryRepository-->>InventoryService: Inventory Entity
        InventoryService->>InventoryEntity: 수량 감소 (decreaseQuantity)
        InventoryEntity->>InventoryEntity: 상태 업데이트 (updateStatus)
        InventoryService->>Database: 변경사항 저장 (Transactional)
    end

    OrderService->>OrderService: 총 금액 계산 (기본+스타일+옵션)
    OrderService->>OrderRepository: 이전 주문 횟수 조회 (countByCustomer)
    OrderRepository-->>OrderService: 주문 횟수
    OrderService->>OrderService: 할인율 계산 (Tier)

    OrderService->>Database: 주문 저장 (save)
    Database-->>OrderService: Saved Order
    OrderService-->>OrderController: orderId
    OrderController-->>Frontend: 200 OK (orderId)
    Frontend-->>Customer: 주문 성공 알림 표시
```

## 4. 음성 주문 (Voice Order)

```mermaid
sequenceDiagram
    actor Customer as 고객
    participant Frontend as 프론트엔드 (음성 화면)
    participant AIServer as AI 서버
    participant ChatOrchestratorService as 채팅 조정 서비스
    participant OrderService as 주문 서비스

    Customer->>Frontend: 마이크 버튼 클릭 및 발화
    Frontend->>AIServer: 오디오 전송
    AIServer->>AIServer: STT 및 의도/메뉴 추출
    AIServer->>ChatOrchestratorService: 주문 요청 전달
    ChatOrchestratorService->>OrderService: 채팅 주문 생성 (createOrderFromChat)
    OrderService->>OrderService: (주문 생성 로직 수행)
    OrderService-->>ChatOrchestratorService: orderId
    ChatOrchestratorService-->>AIServer: 성공 응답
    AIServer-->>Frontend: 주문 확정 메시지
    Frontend-->>Customer: 화면에 확정 내용 표시
```

## 5. 주문 내역 조회 (View Orders)

```mermaid
sequenceDiagram
    actor Staff as 직원
    participant StaffOrderController as 직원 주문 컨트롤러
    participant StaffOrderService as 직원 주문 서비스
    participant OrderRepository as 주문 저장소

    Staff->>StaffOrderController: 주문 목록 요청 (GET /api/staff-orders)
    StaffOrderController->>StaffOrderService: getOrders(status)
    StaffOrderService->>OrderRepository: 상태별 조회 (findByStatus)
    OrderRepository-->>StaffOrderService: List<Order>
    StaffOrderService-->>StaffOrderController: List<OrderResponseDto>
    StaffOrderController-->>Staff: JSON 응답
```

## 6. 주문 상태 변경 - 조리 완료 (Update to Ready)

```mermaid
sequenceDiagram
    actor KitchenStaff as 주방 직원
    participant Frontend as 프론트엔드 (주방 화면)
    participant StaffOrderController as 직원 주문 컨트롤러
    participant StaffOrderService as 직원 주문 서비스
    participant AccessControlService as 접근 제어 서비스
    participant StaffEntity as 직원 엔티티 (다형성)
    participant OrderRepository as 주문 저장소
    participant OrderProcessLogRepository as 로그 저장소
    participant Database as 데이터베이스

    KitchenStaff->>Frontend: "준비 완료(Ready)" 클릭
    Frontend->>StaffOrderController: 상태 변경 요청 (PATCH .../status)
    StaffOrderController->>StaffOrderService: updateStatusAndAudit(READY)

    StaffOrderService->>StaffOrderService: 직원 정보 조회
    StaffOrderService->>AccessControlService: 권한 확인 (verifyStaffAccess)
    AccessControlService->>StaffEntity: canHandle(READY)
    StaffEntity-->>AccessControlService: true (허용)
    AccessControlService-->>StaffOrderService: void

    StaffOrderService->>OrderRepository: 주문 조회 (findById)
    OrderRepository-->>StaffOrderService: Order Entity

    StaffOrderService->>OrderProcessLogRepository: 로그 생성 및 저장 (READY)
    OrderProcessLogRepository->>Database: Insert Log

    StaffOrderService->>Database: 주문 상태 업데이트 (READY)

    StaffOrderService-->>StaffOrderController: void
    StaffOrderController-->>Frontend: 200 OK
    Frontend-->>KitchenStaff: 목록 UI 업데이트
```

## 7. 주문 상태 변경 - 배달 완료 (Update to Delivered)

```mermaid
sequenceDiagram
    actor DeliveryStaff as 배달 직원
    participant Frontend as 프론트엔드 (배달 화면)
    participant StaffOrderController as 직원 주문 컨트롤러
    participant StaffOrderService as 직원 주문 서비스
    participant AccessControlService as 접근 제어 서비스
    participant StaffEntity as 직원 엔티티 (다형성)
    participant OrderRepository as 주문 저장소
    participant Database as 데이터베이스

    DeliveryStaff->>Frontend: "배달 완료" 클릭
    Frontend->>StaffOrderController: 상태 변경 요청 (PATCH .../status)
    StaffOrderController->>StaffOrderService: updateStatusAndAudit(DELIVERED)

    StaffOrderService->>AccessControlService: 권한 확인 (verifyStaffAccess)
    AccessControlService->>StaffEntity: canHandle(DELIVERED)
    StaffEntity-->>AccessControlService: true (허용)

    StaffOrderService->>OrderRepository: 주문 조회
    StaffOrderService->>Database: 로그 저장 (DELIVERED)
    StaffOrderService->>Database: 주문 상태 업데이트 (DELIVERED)

    StaffOrderService-->>StaffOrderController: void
    StaffOrderController-->>Frontend: 200 OK
```

## 8. 재고 관리 - 입고 (Manage Inventory)

```mermaid
sequenceDiagram
    actor Staff as 직원
    participant Frontend as 프론트엔드 (재고 화면)
    participant InventoryController as 재고 컨트롤러
    participant InventoryService as 재고 서비스
    participant InventoryRepository as 재고 저장소
    participant InventoryEntity as 재고 엔티티
    participant Database as 데이터베이스

    Staff->>Frontend: "재고 추가(Order More)" 클릭
    Frontend->>InventoryController: 입고 요청 (POST .../add)
    InventoryController->>InventoryService: increaseQuantity(id, amount)
    InventoryService->>InventoryRepository: 재고 조회 (findById)
    InventoryRepository-->>InventoryService: Inventory Entity
    InventoryService->>InventoryEntity: 수량 증가 (increaseQuantity)
    InventoryEntity->>InventoryEntity: quantity += amount
    InventoryEntity->>InventoryEntity: 상태 업데이트 (updateStatus)
    InventoryService->>Database: 트랜잭션 커밋
    InventoryController-->>Frontend: 200 OK
```
