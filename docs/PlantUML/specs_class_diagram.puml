@startuml
title Comprehensive System Class Diagram
skinparam classAttributeIconSize 0
skinparam linetype ortho

package "Controller" {
    class OrderController {
        +confirmOrder(OrderRequestDto request): ResponseEntity<Long>
        +getOrders(Long customerId): ResponseEntity<List<OrderListResponseDto>>
        +deleteOrder(Long orderId): ResponseEntity<Void>
        +getOrderDetails(Long orderId): ResponseEntity<OrderResponseDto>
    }

    class StaffOrderController {
        +getOrdersByStatus(OrderStatus status): ResponseEntity<List<OrderResponseDto>>
        +updateOrderStatus(Long orderId, Map<String, String> request): ResponseEntity<Void>
    }

    class AuthController {
        +register(UserRegisterRequest request): ResponseEntity<Long>
        +loginUsers(LoginRequest request): ResponseEntity<?>
        +loginStaffs(LoginRequest request): ResponseEntity<?>
    }

    class InventoryController {
        +getAllInventories(): ResponseEntity<List<InventoryResponseDto>>
        +getInventory(Long id): ResponseEntity<InventoryResponseDto>
        +createInventory(InventoryRequestDto requestDto): ResponseEntity<Long>
        +updateQuantity(Long id, Map<String, BigDecimal> request): ResponseEntity<Void>
        +increaseQuantity(Long id, Map<String, BigDecimal> request): ResponseEntity<Void>
        +updateInventory(Long id, InventoryRequestDto requestDto): ResponseEntity<Void>
        +deleteInventory(Long id): ResponseEntity<Void>
    }
}

package "Service" {
    class OrderService {
        +createOrder(OrderRequestDto request): Long
        +createOrderFromChat(Long customerId, String menuName, int quantity): Long
        +getOrders(Long customerId): List<OrderListResponseDto>
        +getOrderDetails(Long orderId): OrderResponseDto
        +deleteOrder(Long orderId)
        -findLatestLogByStatus(List<OrderProcessLog> logs, OrderStatus status): OrderProcessLog
    }

    class StaffOrderService {
        +getOrders(OrderStatus status): List<OrderResponseDto>
        +updateStatusAndAudit(Long orderId, OrderStatus newStatus, Long staffId, String staffRole)
    }

    class InventoryService {
        +getAllInventories(): List<InventoryResponseDto>
        +getInventory(Long id): InventoryResponseDto
        +createInventory(InventoryRequestDto requestDto): Long
        +updateQuantity(Long stockId, BigDecimal newQuantity)
        +increaseQuantity(Long stockId, BigDecimal amount)
        +updateInventoryInfo(Long stockId, InventoryRequestDto requestDto)
        +deleteInventory(Long stockId)
        +deductStock(MenuItem menuItem, int quantity)
    }

    class PricingService {
        +calculateBaseOrderPrice(String dinnerType, String servingStyle, int quantity): BigDecimal
        +calculateOrderItemPrice(MenuItem menuItem, String orderDinnerType, int orderQuantity, int itemQuantity): BigDecimal
        +calculateDiscount(BigDecimal totalPrice, int pastOrderCount): DiscountResult
    }
    
    class AccessControlService {
        +verifyStaffAccess(Staff staff, OrderStatus targetStatus)
    }

    interface AuthenticationService <<interface>> {
        +registerCustomer(Customer customer): Long
        +authenticateCustomer(String email, String password): Customer
        +authenticateStaff(String email, String password): Staff
    }

    class AuthenticationServiceImpl {
        +registerCustomer(Customer customer): Long
        +authenticateCustomer(String email, String password): Customer
        +authenticateStaff(String email, String password): Staff
    }

    class ChatOrchestratorService
}

package "Domain" {
    abstract class User {
        +Long id
        +String name
        +String email
        +String password
        +String phoneNumber
        +String userType
    }

    class Customer {
        +String address
        +CustomerTier tier
    }

    abstract class Staff {
        +String role
        +{abstract} boolean canHandle(OrderStatus status)
    }
    
    class KitchenStaff {
        +boolean canHandle(OrderStatus status)
    }
    class DeliveryStaff {
        +boolean canHandle(OrderStatus status)
    }

    class Order {
        +Long orderId
        +String orderDate
        +String deliveryAddress
        +String dinnerType
        +String servingStyle
        +OrderStatus status
        +BigDecimal totalPrice
        +BigDecimal discountAmount
        +Integer discountRate
        +Integer request
        +addOrderItem(OrderItem item)
    }

    enum OrderStatus {
        PENDING
        INPROGRESS
        READY
        DELIVERED
        CANCELLED
    }

    class OrderItem {
        +Long id
        +int quantity
        +BigDecimal price
        +MenuItem menuItem
    }

    class OrderProcessLog {
        +Long id
        +OrderStatus status
        +Long staffId
        +LocalDateTime processTime
        +String staffRole
    }

    class MenuItem {
        +Long id
        +String name
        +BigDecimal unitPrice
        +boolean isBaseItem
        +String dinnerType
    }

    class Inventory {
        +Long stockID
        +String itemName
        +BigDecimal quantityAvailable
        +String unit
        +BigDecimal minQuantity
        +String status
        +BigDecimal cost
        +updateStatus()
        +decreaseQuantity(BigDecimal amount)
        +increaseQuantity(BigDecimal amount)
    }

    class Recipe {
        +Long id
        +MenuItem menuItem
        +Inventory inventory
        +BigDecimal requiredQuantity
    }
}

package "DTO" {
    class OrderRequestDto
    class OrderResponseDto
    class InventoryRequestDto {
        +String itemName
        +BigDecimal quantityAvailable
        +String unit
        +BigDecimal minQuantity
    }
    class InventoryResponseDto {
        +Long stockID
        +String itemName
        +BigDecimal quantityAvailable
        +String unit
        +BigDecimal minQuantity
        +String status
        +List<String> usedMenus
        +BigDecimal cost
    }
}

package "Repository" {
    interface OrderRepository <<interface>>
    interface CustomerRepository <<interface>>
    interface StaffRepository <<interface>>
    interface MenuItemRepository <<interface>>
    interface InventoryRepository <<interface>>
    interface RecipeRepository <<interface>>
    interface OrderProcessLogRepository <<interface>>
}

' Relationships
User <|-- Customer
User <|-- Staff
Staff <|-- KitchenStaff
Staff <|-- DeliveryStaff

Order "1" --> "1" Customer : ordered by
Order "1" *-- "*" OrderItem : contains
OrderItem "*" --> "1" MenuItem : represents
Order "1" *-- "*" OrderProcessLog : audit log

MenuItem "1" --> "*" Recipe : has recipes
Recipe "*" --> "1" Inventory : uses ingredient

AuthenticationServiceImpl ..|> AuthenticationService
AuthenticationServiceImpl ..> CustomerRepository : uses
AuthenticationServiceImpl ..> StaffRepository : uses

OrderService ..> OrderRepository : uses
OrderService ..> CustomerRepository : uses
OrderService ..> MenuItemRepository : uses
OrderService ..> InventoryService : uses
OrderService ..> PricingService : uses

StaffOrderService ..> OrderRepository : uses
StaffOrderService ..> StaffRepository : uses
StaffOrderService ..> OrderProcessLogRepository : uses
StaffOrderService ..> AccessControlService : uses

InventoryService ..> InventoryRepository : uses
InventoryService ..> RecipeRepository : uses

OrderController ..> OrderService : uses
StaffOrderController ..> StaffOrderService : uses
AuthController ..> AuthenticationService : uses
InventoryController ..> InventoryService : uses

@enduml
